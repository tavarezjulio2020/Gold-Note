@{
    ViewData["Title"] = "Home Page";
}

<div class="main-content" style="max-width: 800px; margin: 0 auto;">

    <div class="text-center py-5">
        <h1 class="display-4 fw-bold text-white">Welcome, @ViewBag.Username</h1>
        <p class="text-muted fs-5">Let's make some music today.</p>
        <div id="teacherAccount"></div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="d-flex align-items-center justify-content-center mb-4">
                <i class="fas fa-music text-gold fa-lg me-2"></i>
                <h3 class="m-0 text-white">My Instruments</h3>
            </div>

            <div id="listOfLearning" class="list-container mb-4">
                <p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</p>
            </div>

            <div class="text-center">
                <button id="manageInstrumentsBtn" type="button" class="btn btn-outline-gold">
                    Manage Instruments
                </button>
            </div>
        </div>
    </div>

    <hr class="my-5 border-secondary" style="opacity: 0.3;">

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="d-flex align-items-center justify-content-center mb-4">
                <i class="fas fa-chalkboard-teacher text-gold fa-lg me-2"></i>
                <h3 class="m-0 text-white">My Teachers</h3>
            </div>

            <div id="listOfTeachers" class="list-container mb-4">
                <p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</p>
            </div>

            <div class="text-center">
                <button id="teacherRegistrationBtn" type="button" class="btn btn-outline-gold">
                    Join a Class
                </button>
            </div>
        </div>
    </div>

    <div class="mt-5 pt-4 text-center">
        <form method="post" asp-controller="Account" asp-action="Logout">
            <button type="submit" class="btn btn-logout-glow px-5 py-2">
                Log Out
            </button>
        </form>
    </div>
</div>

<div id="instrumentModalOverlay" class="custom-modal-overlay" style="display:none;" onclick="if(event.target === this) closeInstrumentModal()">
    <div id="instrumentModal" class="custom-modal-box">
    </div>
</div>

<div id="classRegOverlay" class="custom-modal-overlay" style="display:none;" onclick="if(event.target === this) closeClassModal()">
    <div class="custom-modal-box">
        <div class="text-center mb-4">
            <i class="fas fa-users fa-3x text-gold mb-3"></i>
            <h3 class="text-white">Join a Class</h3>
            <p class="text-muted small">Enter the code provided by your teacher.</p>
        </div>

        <form id="classRegistrationForm">
            <div class="mb-3">
                <label class="text-muted small text-uppercase fw-bold">Class Code</label>
                <input type="text" id="classCode" required class="form-control mt-1 bg-dark text-white border-secondary">
            </div>

            <div class="mb-4">
                <label class="text-muted small text-uppercase fw-bold">Instrument</label>
                <select name="instrument" id="instruments" required class="form-select mt-1 bg-dark text-white border-secondary">
                </select>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-gold">Send Request</button>
                <button type="button" onclick="closeClassModal()" class="btn btn-outline-secondary">Cancel</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let userInstrumentIds = [];

        $(document).ready(function () {
            loadUserInstruments();
            loadUserTeachers();

            $('#manageInstrumentsBtn').click(function () { showManageInstrumentsModal(); });
            $('#teacherRegistrationBtn').click(function () { populateInstRegistration(); });
            $('#classRegistrationForm').submit(function (e) {
                e.preventDefault();
                submitClassRegistration();
            });

            $(document).on('click', '.drop-class-btn', function () {
                var classId = $(this).data('class-id');
                if (confirm("Are you sure you want to drop this class?")) { dropClass(classId); }
            });
        });

        // --- LOAD DATA ---
        function loadUserInstruments() {
            $.ajax({
                url: '/Home/GetMyInstruments', type: 'GET', dataType: 'json',
                success: function (data) {
                    let html = '';
                    userInstrumentIds = data.map(item => item.instrumentId);
                    if (data.length === 0) {
                        html = `<div class="text-center p-4 border border-secondary rounded border-dashed opacity-50">
                                            <p class="m-0">No instruments added yet.</p>
                                        </div>`;
                    } else {
                        data.forEach(item => {
                            html += `<div class="list-card mb-3 d-flex align-items-center">
                                                    <div class="icon-circle">
                                                        <i class="fas fa-music"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="m-0 text-white">${item.instrumentName}</h5>
                                                        <small class="text-muted">Active</small>
                                                    </div>
                                             </div>`;
                        });
                    }
                    $('#listOfLearning').html(html);
                },
                error: function () { $('#listOfLearning').html('<p class="text-danger text-center">Error loading instruments.</p>'); }
            });
        }

        function loadUserTeachers() {
            $.ajax({
                url: '/Home/GetMyTeachers', type: 'GET', dataType: 'json',
                success: function (data) {
                    let html = '';
                    if (data.length === 0) {
                        html = `<div class="text-center p-4 border border-secondary rounded border-dashed opacity-50">
                                            <p class="m-0">No teachers connected.</p>
                                        </div>`;
                    } else {
                        data.forEach(item => {
                            html += `<div class="list-card mb-3 d-flex justify-content-between align-items-center">
                                                    <div class="d-flex align-items-center">
                                                        <div class="icon-circle">
                                                            <i class="fas fa-user-tie"></i>
                                                        </div>
                                                        <div>
                                                            <h5 class="m-0 text-white">${item.name}</h5>
                                                            <small class="text-gold">${item.instName}</small>
                                                        </div>
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-danger drop-class-btn rounded-circle" style="width:32px; height:32px; padding:0;" data-class-id="${item.classId}" title="Drop Class">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                             </div>`;
                        });
                    }
                    $('#listOfTeachers').html(html);
                },
                error: function () { $('#listOfTeachers').html('<p class="text-danger text-center">Error loading teacher list.</p>'); }
            });
        }

        // --- MANAGE INSTRUMENTS (Improved Modal UI) ---
        function showManageInstrumentsModal() {
            $.ajax({
                url: '/Home/GetInstruments', type: 'GET', dataType: 'json',
                success: function (allInstruments) {
                    let modalContent = `
                                <div class="text-center mb-4">
                                    <i class="fas fa-sliders-h fa-2x text-gold mb-2"></i>
                                    <h3 class="text-white">Manage Instruments</h3>
                                    <p class="text-muted small">Select the instruments you are currently learning.</p>
                                </div>
                                <form id="instrumentUpdateForm" class="instrument-list-wrapper">
                            `;
                             
                    allInstruments.forEach(instrument => {
                        const isChecked = userInstrumentIds.includes(instrument.instrumentId); 
                        modalContent += `
                                    <label class="instrument-option-card d-flex align-items-center justify-content-between p-3 mb-2 rounded border border-secondary">
                                        <span class="d-flex align-items-center">
                                            <i class="fas fa-music text-muted me-3"></i>
                                            <span class="text-white lead mb-0" style="font-size: 1.1rem;">${instrument.instrumentName}</span>
                                        </span>
                                        <input type="checkbox" class="form-check-input custom-checkbox" name="instrumentId" value="${instrument.instrumentId}" ${isChecked ? 'checked' : ''}>
                                    </label>
                                `;
                    });

                    modalContent += `
                                <div class="d-grid gap-2 mt-4 pt-3 border-top border-secondary">
                                    <button type="submit" class="btn btn-gold">Save Changes</button>
                                    <button type="button" onclick="closeInstrumentModal()" class="btn btn-outline-secondary">Cancel</button>
                                </div>
                                </form>`;

                    $('#instrumentModal').html(modalContent); 
                    $('#instrumentModalOverlay').css('display', 'flex').hide().fadeIn();
                    $('#instrumentUpdateForm').off('submit').on('submit', handleInstrumentUpdate);
                }
            });
        }

        function handleInstrumentUpdate(e) {
            e.preventDefault();
            let selectedInstrumentIds = [];
            $('input[name="instrumentId"]:checked').each(function () { selectedInstrumentIds.push(parseInt($(this).val())); });
            $.ajax({
                url: '/Home/UpdateMyInstruments', type: 'POST', contentType: 'application/json', data: JSON.stringify(selectedInstrumentIds),
                success: function (response) { if (response.success) { closeInstrumentModal(); loadUserInstruments(); } else { alert('Update failed'); } }
            });
        }

        function populateInstRegistration() {
            $.ajax({
                url: '/Home/GetMyInstruments', type: 'GET', dataType: 'json', success: function (data) {
                    var html = '';
                    if (data.length === 0) { html = '<option disabled selected>Add an instrument first!</option>'; }
                    else { for (let i = 0; i < data.length; i++) { html += '<option value="' + data[i].learnID + '">' + data[i].instrumentName + '</option>'; } }
                    $('#instruments').html(html);
                    $('#classRegOverlay').css('display', 'flex').hide().fadeIn();
                }
            });
        }

        function submitClassRegistration() {
            var classcode = $('#classCode').val(); var instId = $('#instruments').val();
            if (!instId) { alert("Please select an instrument."); return; }
            $.ajax({
                url: '/Home/RegisterForTeacher', data: { code: classcode, studentlearn: instId }, type: 'POST',
                success: function (response) { if (response.success) { alert(response.message); closeClassModal(); } else { alert(response.message); } }
            });
        }

        function closeClassModal() { $('#classRegOverlay').fadeOut(); $('#classCode').val(''); }
        function closeInstrumentModal() { $('#instrumentModalOverlay').fadeOut(); }
        function dropClass(classId) {
            $.ajax({
                url: '/Home/DropClass', type: 'POST', data: { classId: classId },
                success: function (response) { if (response.success) { loadUserTeachers(); } else { alert("Error: " + response.message); } }
            });
        }
    </script>
}

<style>
    .border-dashed {
        border-style: dashed !important;
    }

    .list-card {
        background-color: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px 20px;
        transition: transform 0.2s;
    }

        .list-card:hover {
            border-color: #555;
            background-color: #222;
        }

    .icon-circle {
        width: 45px;
        height: 45px;
        background-color: rgba(255, 215, 0, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #FFD700;
        margin-right: 15px;
    }
     
    .btn-logout-glow {
        background-color: transparent;
        color: #ff4d4d;  
        border: 2px solid #ff4d4d;
        border-radius: 5px;
        font-weight: bold;
        transition: all 0.3s ease;
    }

        .btn-logout-glow:hover {
            background-color: #ff4d4d;
            color: white;
            box-shadow: 0 0 15px rgba(255, 77, 77, 0.4);
        }
         
    .custom-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }

    .custom-modal-box {
        background-color: #121212 !important; 
        border: 1px solid #FFD700;
        padding: 2rem;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 0 40px rgba(0,0,0,0.8);
        color: white;
    }
     
    .instrument-option-card {
        cursor: pointer;
        background-color: #000;
        border: 1px solid #333 !important;
        transition: all 0.2s ease;
    }

        .instrument-option-card:hover {
            border-color: #666 !important;
            background-color: #1a1a1a;
        }
         
        .instrument-option-card:has(input:checked) {
            border-color: #FFD700 !important;
            background-color: rgba(255, 215, 0, 0.05);
        }

    .custom-checkbox {
        width: 1.3em;
        height: 1.3em;
        background-color: #333;
        border-color: #555;
        cursor: pointer;
    }

        .custom-checkbox:checked {
            background-color: #FFD700;
            border-color: #FFD700;
        }
</style>