@{
    ViewData["Title"] = "Home Page";
}

<div class="main-content" style="max-width: 800px; margin: 0 auto;">
    
    <div class="text-center py-5">
        <h1 class="display-4 fw-bold text-white">Welcome, @ViewBag.Username</h1>
        <p class="text-muted fs-5">Let's make some music today.</p>
        <div id="teacherAccount"></div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="d-flex align-items-center justify-content-center mb-4">
                <i class="fas fa-music text-gold fa-lg me-2"></i>
                <h3 class="m-0 text-white">My Instruments</h3>
            </div>
            
            <div id="listOfLearning" class="list-container mb-4">
                <p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</p>
            </div>

            <div class="text-center">
                <button id="manageInstrumentsBtn" type="button" class="btn btn-outline-gold">
                    Manage Instruments
                </button>
            </div>
        </div>
    </div>

    <hr class="my-5 border-secondary" style="opacity: 0.3;">

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="d-flex align-items-center justify-content-center mb-4">
                <i class="fas fa-chalkboard-teacher text-gold fa-lg me-2"></i>
                <h3 class="m-0 text-white">My Teachers</h3>
            </div>

            <div id="listOfTeachers" class="list-container mb-4">
                <p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</p>
            </div>

            <div class="text-center">
                <button id="teacherRegistrationBtn" type="button" class="btn btn-outline-gold">
                    Join a Class
                </button>
            </div>
        </div>
    </div>

    <div class="mt-5 pt-4 text-center">
        <form method="post" asp-controller="Account" asp-action="Logout">
            <button type="submit" class="btn btn-outline-danger px-4" style="border-radius: 5px;">
                Log Out
            </button>
        </form>
    </div>
</div>

<div id="instrumentModalOverlay" class="custom-modal-overlay" style="display:none;" onclick="if(event.target === this) closeInstrumentModal()">
    <div id="instrumentModal" class="custom-modal-box">
        </div>
</div>

<div id="classRegOverlay" class="custom-modal-overlay" style="display:none;" onclick="if(event.target === this) closeClassModal()">
    <div class="custom-modal-box">
        <div class="text-center mb-4">
            <i class="fas fa-users fa-3x text-gold mb-3"></i>
            <h3 class="text-white">Join a Class</h3>
            <p class="text-muted small">Enter the code provided by your teacher.</p>
        </div>
        
        <form id="classRegistrationForm">
            <div class="mb-3">
                <label class="text-muted small text-uppercase fw-bold">Class Code</label>
                <input type="text" id="classCode" required class="form-control mt-1">
            </div>

            <div class="mb-4">
                <label class="text-muted small text-uppercase fw-bold">Instrument</label>
                <select name="instrument" id="instruments" required class="form-select mt-1">
                </select>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-gold">Send Request</button>
                <button type="button" onclick="closeClassModal()" class="btn btn-outline-secondary">Cancel</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let userInstrumentIds = [];

        $(document).ready(function () {
            loadUserInstruments();
            loadUserTeachers();

            $('#manageInstrumentsBtn').click(function () { showManageInstrumentsModal(); });
            $('#teacherRegistrationBtn').click(function () { populateInstRegistration(); });
            $('#classRegistrationForm').submit(function (e) {
                e.preventDefault();
                submitClassRegistration();
            });

            $(document).on('click', '.drop-class-btn', function () {
                var classId = $(this).data('class-id');
                if (confirm("Are you sure you want to drop this class?")) { dropClass(classId); }
            });
        });

        // --- LOAD DATA ---
        function loadUserInstruments() {
            $.ajax({
                url: '/Home/GetMyInstruments', type: 'GET', dataType: 'json',
                success: function (data) {
                    let html = '';
                    userInstrumentIds = data.map(item => item.instrumentId);
                    if (data.length === 0) {
                        html = `<div class="text-center p-4 border border-secondary rounded border-dashed opacity-50">
                                    <p class="m-0">No instruments added yet.</p>
                                </div>`;
                    } else {
                        data.forEach(item => {
                            html += `<div class="list-card mb-3 d-flex align-items-center">
                                        <div class="icon-circle">
                                            <i class="fas fa-music"></i>
                                        </div>
                                        <div>
                                            <h5 class="m-0 text-white">${item.instrumentName}</h5>
                                            <small class="text-muted">Active</small>
                                        </div>
                                     </div>`;
                        });
                    }
                    $('#listOfLearning').html(html);
                },
                error: function () { $('#listOfLearning').html('<p class="text-danger text-center">Error loading instruments.</p>'); }
            });
        }

        function loadUserTeachers() {
            $.ajax({
                url: '/Home/GetMyTeachers', type: 'GET', dataType: 'json',
                success: function (data) {
                    let html = '';
                    if (data.length === 0) {
                        html = `<div class="text-center p-4 border border-secondary rounded border-dashed opacity-50">
                                    <p class="m-0">No teachers connected.</p>
                                </div>`;
                    } else {
                        data.forEach(item => {
                            html += `<div class="list-card mb-3 d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="icon-circle">
                                                <i class="fas fa-user-tie"></i>
                                            </div>
                                            <div>
                                                <h5 class="m-0 text-white">${item.name}</h5>
                                                <small class="text-gold">${item.instName}</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger drop-class-btn rounded-circle" style="width:32px; height:32px; padding:0;" data-class-id="${item.classId}" title="Drop Class">
                                            <i class="fas fa-times"></i>
                                        </button>
                                     </div>`;
                        });
                    }
                    $('#listOfTeachers').html(html);
                },
                error: function () { $('#listOfTeachers').html('<p class="text-danger text-center">Error loading teacher list.</p>'); }
            });
        }

        // --- MANAGE INSTRUMENTS (Vertical List Modal) ---
        function showManageInstrumentsModal() {
            $.ajax({
                url: '/Home/GetInstruments', type: 'GET', dataType: 'json',
                success: function (allInstruments) {
                    let modalContent = '<div class="text-center mb-4"><h3 class="text-white">Manage Instruments</h3><p class="text-muted small">Select the instruments you are learning</p></div><form id="instrumentUpdateForm">';
                    
                    // Simple Vertical List
                    allInstruments.forEach(instrument => {
                        const isChecked = userInstrumentIds.includes(instrument.instrumentId);
                        modalContent += `
                            <div class="mb-3 pb-2 border-bottom border-secondary d-flex align-items-center">
                                <input type="checkbox" id="inst-${instrument.instrumentId}" name="instrumentId" value="${instrument.instrumentId}" ${isChecked ? 'checked' : ''} style="transform: scale(1.3); accent-color: #FFD700; margin-right: 15px;">
                                <label class="text-white lead mb-0" for="inst-${instrument.instrumentId}" style="cursor: pointer;">
                                    ${instrument.instrumentName}
                                </label>
                            </div>`;
                    });

                    modalContent += `<div class="d-grid gap-2 mt-4">
                                        <button type="submit" class="btn btn-gold">Save Changes</button>
                                        <button type="button" onclick="closeInstrumentModal()" class="btn btn-outline-secondary">Cancel</button>
                                     </div></form>`;

                    $('#instrumentModal').html(modalContent);
                    $('#instrumentModalOverlay').fadeIn();
                    $('#instrumentUpdateForm').off('submit').on('submit', handleInstrumentUpdate);
                }
            });
        }

        function handleInstrumentUpdate(e) {
            e.preventDefault();
            let selectedInstrumentIds = [];
            $('input[name="instrumentId"]:checked').each(function () { selectedInstrumentIds.push(parseInt($(this).val())); });
            $.ajax({
                url: '/Home/UpdateMyInstruments', type: 'POST', contentType: 'application/json', data: JSON.stringify(selectedInstrumentIds),
                success: function (response) { if (response.success) { closeInstrumentModal(); loadUserInstruments(); } else { alert('Update failed'); } }
            });
        }

        function populateInstRegistration() {
            $.ajax({ url: '/Home/GetMyInstruments', type: 'GET', dataType: 'json', success: function (data) {
                var html = '';
                if (data.length === 0) { html = '<option disabled selected>Add an instrument first!</option>'; } 
                else { for (let i = 0; i < data.length; i++) { html += '<option value="' + data[i].learnID + '">' + data[i].instrumentName + '</option>'; } }
                $('#instruments').html(html); $('#classRegOverlay').fadeIn();
            }});
        }

        function submitClassRegistration() {
            var classcode = $('#classCode').val(); var instId = $('#instruments').val();
            if (!instId) { alert("Please select an instrument."); return; }
            $.ajax({ url: '/Home/RegisterForTeacher', data: { code: classcode, studentlearn: instId }, type: 'POST',
                success: function (response) { if (response.success) { alert(response.message); closeClassModal(); } else { alert(response.message); } }
            });
        }

        function closeClassModal() { $('#classRegOverlay').fadeOut(); $('#classCode').val(''); }
        function closeInstrumentModal() { $('#instrumentModalOverlay').fadeOut(); }
        function dropClass(classId) {
            $.ajax({ url: '/Home/DropClass', type: 'POST', data: { classId: classId },
                success: function (response) { if (response.success) { loadUserTeachers(); } else { alert("Error: " + response.message); } }
            });
        }
    </script>
    
    <style>
        .border-dashed { border-style: dashed !important; }
        .list-card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px 20px;
        }

        /* --- FORCE MODAL TO BE ON TOP (Fixes "Bottom of page" issue) --- */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 9999; /* Top level */
            display: flex; /* Centers content */
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .custom-modal-box {
            background-color: #000;
            border: 1px solid #FFD700;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.2);
            color: white;
        }
    </style>
}