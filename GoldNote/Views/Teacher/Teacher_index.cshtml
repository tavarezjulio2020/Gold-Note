@* Teacher_index.cshtml (Updated Structure) *@
@* Assuming this view receives List<StudentDashboardItem> as its Model *@

<div class="text-center">
    <h1 class="display-4 gold">@ViewBag.Username</h1>
    
    <div class="d-flex justify-content-center align-items-center mb-4">
        
        <h2 class="m-0 me-3">Class Code: @ViewBag.ClassCode.ClassCode</h2>
        
        <div style="position: relative;">
            <button type="button" class="btn btn-lg" data-bs-toggle="modal" data-bs-target="#RequestModal" style="color: white; padding: 0.5rem;">
                <i class="fas fa-envelope" style="position: relative;">
                    <span id="request-badge" class="notification-badge hidden"></span>
                </i>
            </button>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-md-10 offset-md-1">
        <table class="table table-hover table-striped">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Instrument</th>
                    <th>Practice (Total)</th>
                    <th>Assignments</th> 
                </tr>
            </thead>
            <tbody id="studentTableBody">
                </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="RequestModal" tabindex="-1" aria-labelledby="RequestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="RequestModalLabel">Pending Classroom Requests</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="requestsContainer">
                    <p class="text-center text-muted">Loading requests...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="AssignmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="assignmentModalTitle">Assignments for [Student Name]</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div id="assignmentListContainer" class="mb-4">
                    </div>

                <hr />

                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-plus-circle"></i> Add New Assignment</h6>
                        <form id="addAssignmentForm">
                            <input type="hidden" id="currentStudentLearnId" />
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="newTitle" placeholder="Assignment Title" required>
                                </div>
                                <div class="col-md-6">
                                    <textarea class="form-control" id="newNotes" placeholder="Notes/Description..."></textarea>
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-success w-100">Add Assignment</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {
            
           getStudents();
           checkInitialRequests();
            
            $('#RequestModal').on('show.bs.modal', function (e) {
                loadRequests();
            });

            $(document).on('click', '.accept-btn', function() {
                var requestId = $(this).data('request-id');
                var studentLearnId = $(this).data('student-learn-id');
                processRequest(requestId, studentLearnId, 'Acceptrequest');
            });
            
            $(document).on('click', '.reject-btn', function() {
                var requestId = $(this).data('request-id');
                // Note: For reject, we don't need studentLearnId, so we pass null/0
                processRequest(requestId, 0, 'Rejectrequest'); 
            });

        });

        // A single function to handle both accept (POST) and reject (DELETE) logic
        function processRequest(requestId, studentLearnId, actionName) {
            
            // Determine the HTTP verb based on the action being performed
            let httpVerb = 'POST';
            if (actionName === 'Rejectrequest') {
                httpVerb = 'DELETE'; 
            }
            
            $.ajax({
                url: '/Teacher/' + actionName, 
                type: httpVerb, 
                dataType: 'json',
                data: { 
                    requestId: requestId,
                    studentLearnId: studentLearnId 
                },
                success: function(response) {
                    alert(response.message);  
                    loadRequests();  
                    getStudents();  
                    checkInitialRequests(); 
                },
                error: function(xhr, status, error) {
                    var response = xhr.responseJSON;
                    var errorMessage = response ? response.message : "An unexpected error occurred.";
                    alert("Error: " + errorMessage); 
                }
            });
        }

        function checkInitialRequests() {
            $.ajax({
                url: '/Teacher/GetJoinRequest', 
                dataType: 'json',
                type: 'GET',
                success: function(data) {
                    // Update the badge status immediately after fetching the data
                    updateRequestBadge(data.length); 
                }
            });
        }

        function updateRequestBadge(count) {
            const $badge = $('#request-badge');
            if (count > 0) {
                $badge.removeClass('hidden');
            } else {
                $badge.addClass('hidden');
            }
        }

        function getStudents(){
           $.ajax({
                     url: '/Teacher/GetMyStudents',
              datatype:'json',
              type: 'GET',
              success: function(data) {
                 console.log(data);
                 var html = "";
                 for(let i=0; i<data.length; i++){
                    html += "<tr><td>" +data[i].studentName+"</td><td>" + data[i].instrumentName + "</td><td>"+ timeDisplay(data[i].secondsPracticed) +"</td><td> Assingments </td></tr>";
                 }
                 $('#studentTableBody').html(html);
              }
           });
        }

        function loadRequests() { 
           var $container = $('#requestsContainer');
           $container.html('<p class="text-center text-muted">Loading requests...</p>'); 
            $.ajax({
               url: '/Teacher/GetJoinRequest', // ✅ Correct URL as confirmed
               dataType: 'json',
               type: 'GET',
               success: function(data) {
                  console.log('Request to join class', data);
            
                  if (data.length === 0) {
                      $container.html('<p class="text-center text-muted">No new classroom requests currently pending.</p>');
                      return;
                  }

                  // Start building a proper HTML table with headers
                  var html = '<table class="table table-hover table-sm">';
                  html += '<thead><tr><th>Student</th><th>Instrument</th><th>Actions</th></tr></thead>';
                  html += '<tbody>'; 
                  
                  for(let i = 0; i < data.length; i++){
                      var request = data[i];  
                      html += "<tr>"; 
                      html += "<td>" + request.studentName + "</td>"; 
                      html += "<td>" + request.instrumentName + "</td>";  
                      var requestId = request.requestId;  

                      html += "<td>"; 
                      var studentLearnId = request.learnId;
                       
                      html += `<button type="button" class="btn btn-success btn-sm me-2 accept-btn" data-request-id="${requestId}" data-student-learn-id="${studentLearnId}">Accept</button>`;
                      html += `<button type="button" class="btn btn-danger btn-sm reject-btn" data-request-id="${requestId}">Reject</button>`;
                      html += "</td>"; 
                      html += "</tr>";
                  }
                  html += "</tbody></table>"; 
                  $container.html(html);
               },
               error: function(xhr, status, error) {
                  console.error("Error loading requests:", status, error);
                  $container.html('<p class="text-center text-danger">Failed to load requests. Please check the console.</p>');
               }
            });
        }

        function timeDisplay(totalSeconds) {
            // Ensure we start with a positive integer
            if (typeof totalSeconds !== 'number' || totalSeconds < 0) {
                return "0s";
            }

            var hours;
            var minutes;
            var seconds;

            seconds = totalSeconds % 60;
            var remainingMinutes = Math.floor(totalSeconds / 60); 
            minutes = remainingMinutes % 60;
            hours = Math.floor(remainingMinutes / 60); 
            var parts = [];

            if (hours > 0) {
                parts.push(hours + 'h');
            }

            if (minutes > 0) {
                parts.push(minutes + 'm');
            }

            // Only display seconds if there's no hour or minute component, OR if it's explicitly non-zero
            if (seconds > 0 || (totalSeconds === 0 && parts.length === 0)) {
                parts.push(seconds + 's');
            }

            return parts.join(' ');
        }

      function updateRequestBadge(count) {
            const $badge = $('#request-badge');
            if (count > 0) {
                $badge.removeClass('hidden');
                // Optional: You could show the actual count here: $badge.text(count);
            } else {
                $badge.addClass('hidden');
            }
        }
    </script>

<style>
     /* Table Header Visibility Fix */
    .table thead th {
        color: white !important; 
    }

    /* Red Dot Styling */
    .notification-badge {
        position: absolute;
        top: 0;
        right: 0;
        width: 8px; /* Adjusted size */
        height: 8px; /* Adjusted size */
        border-radius: 50%;
        background-color: red;
        z-index: 10;
        border: 1px solid white;
        
        /* Positioning trick: Shift it relative to its own size to sit exactly on the corner */
        transform: translate(50%, -50%); 
    }

    /* Fix to anchor the badge to the icon itself */
    .top-right-icon button i, .d-flex button i {
        position: relative; /* Ensure the badge positions correctly */
        display: inline-block;
        padding: 0 5px; 
    }

    .hidden {
        display: none;
    }
</style>
}